angular.module("hbpDocumentClient.core",["bbpConfig","hbpCommon"]),angular.module("hbpDocumentClient.ui",["bbpConfig","hbpCommon","hbpDocumentClientTemplates","hbpDocumentClient.core"]),angular.module("hbpDocumentClient",["hbpDocumentClient.core","hbpDocumentClient.ui"]),angular.module("hbpDocumentClientTemplates",["templates/file-browser-folder.html","templates/file-browser-path.html","templates/file-browser-tooltip.html","templates/file-browser.html","templates/file-icon.html","templates/file-upload-area.html","templates/mini-browser.html"]),angular.module("templates/file-browser-folder.html",[]).run(["$templateCache",function(a){a.put("templates/file-browser-folder.html",'<div class="hbp-file-browser-item hbp-file-browser-folder"\n    ng-dblclick="browserView.handleNavigation(folder)"\n    ng-click="browserView.handleFocus(folder)"\n    hbp-on-touch="browserView.handleNavigation(folder)"\n    ng-class="{\'hbp-file-browser-item-selected\': browserView.selectedEntity === folder}">\n    <div class="hbp-file-browser-label">\n        <i class="fa" ng-class="folderIcon ? folderIcon : \'fa-folder\'"></i><span>{{folderLabel || folder._name}}</span>\n    </div>\n</div>\n')}]),angular.module("templates/file-browser-path.html",[]).run(["$templateCache",function(a){a.put("templates/file-browser-path.html",'<ul class="breadcrumb hbp-file-browser-path">\n    <li class="root"\n      ng-if="!browserView.isRoot">\n      <a href ng-click="browserView.handleNavigation(browserView.rootEntity)">\n        {{browserView.rootEntity._name || \'[top]\'}}\n      </a>\n    </li>\n    <li ng-repeat="entity in ancestors">\n      <a href ng-click="browserView.handleNavigation(entity)">\n        {{entity._name}}\n      </a>\n    </li>\n    <li>\n      <span class="active">{{browserView.currentEntity._name || \'[top]\'}}</span>\n    </li>\n</ul>\n')}]),angular.module("templates/file-browser-tooltip.html",[]).run(["$templateCache",function(a){a.put("templates/file-browser-tooltip.html",'<div ng-init="browserView.defineThumbnailUrl(file)">\n  <div class="file-browser-thumbnail thumbnail" ng-if="browserView.thumbnailUrl" aria-hidden="true">\n    <img ng-src="{{browserView.thumbnailUrl}}">\n  </div>\n  {{file._name}}\n</div>\n')}]),angular.module("templates/file-browser.html",[]).run(["$templateCache",function(a){a.put("templates/file-browser.html",'<div class="hbp-file-browser container-fluid" in-view-container ng-click="selectItem()">\n  <hbp-error-message hbp-error=\'browserView.error\'></hbp-error-message>\n  <div class="navbar navbar-default">\n    <div class="container-fluid">\n      <div class="nav navbar-nav navbar-text">\n        <hbp-file-browser-path></hbp-file-browser-path>\n      </div>\n      <div class="dropdown nav navbar-nav pull-right" dropdown ng-if="browserView.canEdit">\n        <button type="button" href class="btn btn-default navbar-btn dropdown-toggle" dropdown-toggle>\n          <span class="glyphicon glyphicon-plus"></span>\n          <span class="caret"></span>\n        </button>\n        <ul class="dropdown-menu" role="menu">\n          <li ng-if="browserView.canEdit"><a href ng-click="browserView.startCreateFolder()"><span class="fa fa-folder"></span> Create Folder</a></li>\n          <li ng-if="browserView.canEdit"><a href ng-click="browserView.showFileUpload = true"><span class="fa fa-file"></span> Upload File</a></li>\n        </ul>\n      </div>\n    </div>\n  </div>\n  <div class="hbp-file-browser-content">\n      <div ng-if="browserView.isLoading" class="alert alert-info" role="alert">Loading...</div>\n      <div class="file-browser-upload" ng-if="browserView.showFileUpload" >\n        <button type="button" class="btn close pull-right"\n          ng-click="browserView.showFileUpload = false">\n          <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>\n        </button>\n        <hbp-file-upload-area on-drop="browserView.onFileChanged(files)" on-error="browserView.setError(error)"></hbp-file-upload-area>\n      </div>\n      <ul>\n          <!-- navigate up one level -->\n          <li ng-if="!browserView.isRoot" hbp-file-browser-folder="browserView.parent" hbp-file-browser-folder-label=".." hbp-file-browser-folder-icon="fa-level-up"></li>\n\n          <!-- folders -->\n          <li ng-repeat="folder in browserView.folders" hbp-file-browser-folder="folder"></li>\n          <li ng-if="browserView.showCreateFolder" class="hbp-file-browser-item">\n            <div class="hbp-file-browser-folder">\n              <form class="form form-inline" action="index.html" method="post" ng-submit="browserView.doCreateFolder($event)">\n                <div class="input-group">\n                  <input type="text" class="form-control new-folder-name" name="newFolderName" ng-model="browserView.newFolderName">\n                  <span class="input-group-btn">\n                    <input class="btn btn-primary" type="submit" name="name" value="Ok">\n                    <button class="btn btn-default" type="button" ng-click="browserView.cancelCreateFolder()">\n                      <span aria-hidden="true">&times;</span><span class="sr-only">Cancel</span>\n                    </button>\n                  </span>\n                </div>\n              </form>\n            </div>\n          </li>\n          <li class="hbp-file-browser-item"\n              ng-if="browserView.hasMoreFolders">\n            <a href class="hbp-file-browser-label btn" hbp-perform-action="browserView.loadMoreFolders()">\n              <span class="fa fa-refresh"></span>\n              Load More Folders\n            </a>\n          </li>\n\n          <!-- files -->\n          <li ng-repeat="file in browserView.files"\n              ng-dblclick="browseToEntity(file)"\n              ng-click="browserView.handleFocus(file)"\n              tooltip-template="\'templates/file-browser-tooltip.html\'" tooltip-placement="bottom" tooltip-popup-delay="600"\n              class="hbp-file-browser-item"\n              ng-class="{ \'hbp-file-browser-item-selected\': browserView.selectedEntity === file }">\n              <div class="hbp-file-browser-label">\n                  <hbp-content-icon content="file._contentType"></hbp-content-icon>\n                  <span>{{file._name || file._uuid}}</span>\n              </div>\n          </li>\n            <!-- uploads -->\n          <li ng-repeat="uploadInfo in browserView.uploads"\n              ng-click="browserView.handleFocus(null)"\n              tooltip="{{uploadInfo.content.name}}" tooltip-placement="bottom" tooltip-popup-delay="600"\n              class="hbp-file-browser-item" ng-class="\'hbp-file-browser-state-\' + uploadInfo.state">\n              <div class="hbp-file-browser-label">\n                  <hbp-content-icon content="file._contentType"></hbp-content-icon>\n                  <span>{{uploadInfo.content.name}}</span>\n              </div>\n              <div class="hbp-file-browser-item-upload progress">\n                <div class="progress-bar" role="progressbar"\n                     aria-valuenow="{{uploadInfo.progress}}"\n                     aria-valuemin="0" aria-valuemax="100"\n                     style="width: {{uploadInfo.progress.percentage}}%">\n                     <span class="sr-only">{{uploadInfo.progress.percentage}}% Complete</span>\n                </div>\n              </div>\n          </li>\n            <!-- load more files -->\n          <li class="hbp-file-browser-item"\n              ng-if="browserView.hasMoreFiles">\n            <a href class="hbp-file-browser-label btn" hbp-perform-action="browserView.loadMoreFiles()">\n              <span class="fa fa-refresh"></span>\n              Load more files\n            </a>\n          </li>\n      </ul>\n  </div>\n</div>\n')}]),angular.module("templates/file-icon.html",[]).run(["$templateCache",function(a){a.put("templates/file-icon.html",'<span class="bbp-browser-entity-icon" ng-switch="type">\n    <i ng-switch-when="root" class="glyphicon glyphicon-home"></i>\n    <i ng-switch-when="project" class="glyphicon glyphicon-hdd"></i>\n    <i ng-switch-when="folder" class="glyphicon glyphicon-folder-open"></i>\n    <i ng-switch-when="file" class="glyphicon glyphicon-file"></i>\n    <i ng-switch-when="release" class="glyphicon glyphicon-lock"></i>\n    <i ng-switch-when="link:folder" class="glyphicon glyphicon-link"></i>\n    <i ng-switch-when="link:file" class="glyphicon glyphicon-link"></i>\n    <i ng-switch-when="link:project" class="glyphicon glyphicon-link"></i>\n    <i ng-switch-when="link:release" class="glyphicon glyphicon-link"></i>\n</span>\n')}]),angular.module("templates/file-upload-area.html",[]).run(["$templateCache",function(a){a.put("templates/file-upload-area.html",'<div class="hbp-drop-zone" ng-class="{\'hbp-drop-zone-drag-enter\': dragEntered, \'hbp-drop-zone-drag-leave\': !dragEntered}" ng-cloak>\n    <h4>Drop Files Here to Upload</h4>\n    <span>or</span>\n    <div class="btn btn-default hbp-drop-zone-btn-file">\n        Select Files <input type="file" multiple onchange="angular.element(this).scope().onFileChanged(this.files)" >\n    </div>\n</div>\n')}]),angular.module("templates/mini-browser.html",[]).run(["$templateCache",function(a){a.put("templates/mini-browser.html",'<div class="hbp-mini-browser">\n    <ul ng-if="currentEntity.children.list === undefined">\n        <li><bbp-loading class="bbp-browser-loading"/></li>\n    </ul>\n    <ul  ng-if="currentEntity.children.list !== undefined">\n        <li ng-if="!currentEntity.root">\n            <a ng-click="back($event)"><i class="hbp-browser-entity-icon fa fa-level-up"></i>..</a>\n        </li>\n        <li ng-if="currentEntity.children.list.length === 0"><span class="no-entity">Empty</span></li>\n        <li ng-repeat="child in currentEntity.children.list">\n            <a ng-if="isBrowsable(child)" ng-click="browseTo(child, $event)" ng-mouseover="mouseOver(child)">\n                <hbp-file-icon entity="child"></hbp-file-icon>\n                {{child._name}}\n                <button ng-if="isSelectable(child)" ng-click="select(child, $event)" class="btn btn-xs btn-default">Select</button>\n            </a>\n            <span ng-if="!isBrowsable(child)" ng-class="{disabled: !isSelectable(child)}" ng-mouseover="mouseOver(child)">\n                <hbp-file-icon entity="child"></hbp-file-icon>\n                {{child._name}}\n                <button ng-if="isSelectable(child)" ng-click="select(child, $event)" class="btn btn-xs btn-default">Select</button>\n            </span>\n        </li>\n        <li ng-if="currentEntity.children.hasNext"><a class="hbp-mini-browser-more" ng-click="loadMore()">Load more</a></li>\n    </ul>\n</div>\n')}]),function(){"use strict";function a(){return{restrict:"E",scope:{entity:"=?",root:"="},templateUrl:"templates/file-browser.html",link:d,controllerAs:"browserView",controller:e}}function b(){return{restrict:"A",require:"^hbpFileBrowser",templateUrl:"templates/file-browser-folder.html",scope:{folder:"=hbpFileBrowserFolder",folderIcon:"@hbpFileBrowserFolderIcon",folderLabel:"@hbpFileBrowserFolderLabel"},link:function(a,b,c,d){a.browserView=d}}}function c(a){return{restrict:"E",require:"^hbpFileBrowser",templateUrl:"templates/file-browser-path.html",link:function(b,c,d,e){var f=function(a){b.ancestors=a},g=function(){a.getAncestors(e.currentEntity,e.rootEntity).then(f,e.setError)};b.browserView=e,b.$watch("browserView.currentEntity",g)}}}function d(a,b,c,d){var e=a.$watch("root",function(b){if(!angular.isUndefined(b)){d.init(b,a.entity);var c=a.$watch("entity",d.handleNavigation);a.$on("$destroy",c),e()}});a.$on("$destroy",e),a.$on("hbpFileBrowser:startCreateFolder",function(a){a.preventDefault(),b.find(".new-folder-name").get(0).focus()})}function e(a,b,c,d,e,f,g,h){function i(a,b){A.rootEntity=a,B=p(b||a)}function j(b){b!==A.selectedEntity&&(a.$emit("hbpFileBrowser:focusChanged",b,A.selectedEntity),A.selectedEntity=b)}function k(a){angular.isUndefined(a)||a===A.currentEntity||(B=B["finally"](function(){return p(a)}))}function l(a){b.error("error catched by file browser:",a),A.error=a,A.isLoading=!1}function m(){A.showCreateFolder=!0,d(function(){a.$emit("hbpFileBrowser:startCreateFolder")})}function n(a){a.preventDefault(),g.create("folder",A.currentEntity,A.newFolderName).then(function(a){return A.newFolderName="",p(a)}).then(function(){A.showFileUpload=!0})["catch"](l)}function o(){A.newFolderName="",A.showCreateFolder=!1}function p(a){if(A.isLoading=!0,A.currentEntity=a,A.selectedEntity=a,A.error=null,A.parent=null,A.files=null,A.folders=null,A.uploads=[],A.showFileUpload=!1,A.showCreateFolder=!1,u(a),z(a),!a)return e.getAll().then(function(a){A.folders=a.result}).then(function(){A.isLoading=!1})["catch"](l);var b=[];return!A.isRoot&&a._parent&&b.push(g.get(a._parent).then(v)),C=h(a,{accept:["folder"],acceptLink:!1}),A.folders=C.entities,b.push(C.promise.then(t)),D=h(a,{accept:["file"],acceptLink:!1}),A.files=D.entities,b.push(D.promise.then(s)),c.all(b).then(function(){A.isLoading=!1},l)}function q(){return D.next().then(s)["catch"](l)}function r(){return C.next().then(t)["catch"](l)}function s(){A.hasMoreFiles=D.hasNext}function t(){A.hasMoreFolders=C.hasNext}function u(a){a?A.rootEntity?A.isRoot=a._uuid===A.rootEntity._uuid:A.isRoot=!1:A.isRoot=!0}function v(a){A.parent=a}function w(a){_.each(a,function(a){x(a).then(function(a){A.files.push(a)})}),A.showFileUpload=!1}function x(a){var d={content:a,state:null};return A.uploads.push(d),f.upload(a,{parent:A.currentEntity}).then(function(b){return a.state="success",_.remove(A.uploads,function(a){return a===d}),b},function(a){return b.error("upload error:",a),d.state="error",l(a),c.reject(a)},function(a){a&&a.lengthComputable&&(d.state="progress",d.progress=a,d.progress.percentage=100*a.loaded/a.total)})}function y(a){A.thumbnailUrl=null,a._contentType&&a._contentType.match(/^image\//)&&f.downloadUrl(a).then(function(a){A.thumbnailUrl=a})}function z(a){return E=E.then(function(){return a?g.getUserAccess(a).then(function(a){A.canEdit=a.canWrite}):void(A.canEdit=!1)})}var A=this;A.currentEntity=null,A.folders=[],A.hasMoreFolders=!1,A.files=[],A.uploads=[],A.hasMoreFiles=!1,A.selectedEntity=null,A.rootEntity=null,A.isRoot=!0,A.error=null,A.isLoading=!0,A.canEdit=!1,A.thumbnailUrl=null,A.init=i,A.handleFocus=j,A.handleNavigation=k,A.loadMoreFiles=q,A.loadMoreFolders=r,A.onFileChanged=w,A.startCreateFolder=m,A.doCreateFolder=n,A.cancelCreateFolder=o,A.defineThumbnailUrl=y;var B,C,D,E=c.when()}angular.module("hbpDocumentClient.ui").directive("hbpFileBrowser",a).directive("hbpFileBrowserPath",c).directive("hbpFileBrowserFolder",b),c.$inject=["hbpEntityStore"],e.$inject=["$scope","$log","$q","$timeout","hbpProjectStore","hbpFileStore","hbpEntityStore","hbpLoadEntityChildren"]}(),function(){"use strict";function a(){return{templateUrl:"templates/file-icon.html",restrict:"E",scope:{entity:"=?",type:"=?"},link:function(a){!a.type&&a.entity&&(a.type=a.entity._entityType)}}}angular.module("hbpDocumentClient.ui").directive("hbpFileIcon",a)}(),angular.module("hbpCommon"),angular.module("hbpDocumentClient.ui").directive("hbpFileUploadArea",function(){"use strict";return{templateUrl:"templates/file-upload-area.html",restrict:"E",scope:{onDrop:"&",onError:"&",foldersAllowed:"="},link:function(a,b){function c(a){var b=[],c=a.items;if(c)for(var d=0;d<c.length;d++)c[d].webkitGetAsEntry().isDirectory&&b.push(c[d].webkitGetAsEntry().name);else for(var e=a.files,f=0;f<e.length;f++)e[f].size%4096===0&&b.push(e[f].name);return b}var d=function(a){a.preventDefault(),a.stopPropagation()},e=function(b){b.preventDefault(),b.stopPropagation(),a.dragEntered=!0,a.$apply()},f=function(b){b.preventDefault(),b.stopPropagation(),a.dragEntered=!1,a.$apply()};a.processDrop=function(b){if(b.preventDefault(),b.stopPropagation(),!b.dataTransfer&&b.originalEvent&&(b.dataTransfer=b.originalEvent.dataTransfer),a.dragEntered=!1,!a.foldersAllowed){var d=c(b.dataTransfer);if(d.length>0){var e=new Error("Folders not allowed");return e.name="foldersNotAllowed",e.files=d,a.onError({error:e}),!1}}a.onDrop({files:b.dataTransfer.files})},a.onFileChanged=function(b){a.onDrop({files:b})},b.on("dragover",d),b.on("dragenter",e),b.on("dragleave",f),b.on("drop",a.processDrop)}}}),function(){"use strict";angular.module("hbpDocumentClient.ui").directive("hbpMiniBrowser",["hbpEntityStore","hbpProjectStore",function(a,b){return{restrict:"E",templateUrl:"templates/mini-browser.html",scope:{selection:"&hbpSelection",selectable:"&hbpSelectable",browsable:"&hbpBrowsable",hovered:"&hbpHovered",entity:"=hbpCurrentEntity"},controller:["$scope","$q",function(c,d){function e(c,e){var f=!c,g=_.extend({},e),h=_.extend({},e,{access:"write",from:null,pageSize:0});return f?d.all({all:b.getAll(g),write:b.getAll(h)}).then(function(a){var b=_.pluck(a.write.result,"_uuid");return _.forEach(a.all.result,function(a){a.canRead=!0,a.canWrite=-1!==b.indexOf(a._uuid)}),{list:a.all.result,hasNext:a.all.hasMore}}):a.getChildren(c).then(function(a){return{list:a.result,hasNext:a.hasMore}})}function f(a,b,c){return{root:a,entity:b||null,children:c||{}}}c.back=function(b){if(b.preventDefault(),!c.currentEntity.root){var d=c.currentEntity.entity._parent;d?(c.currentEntity=f(!1),a.get(d).then(function(a){c.currentEntity.entity=a,e(a).then(function(a){c.currentEntity.children=a})})):(c.currentEntity=f(!0),e().then(function(a){c.currentEntity.children=a}))}},c.browseTo=function(a,b){b.preventDefault(),c.currentEntity=f(!1,a),e(a).then(function(a){c.currentEntity.children=a})},c.loadMore=function(){var a=c.currentEntity.children.list[c.currentEntity.children.list.length-1]._uuid,b=function(a){a.list.shift(),Array.prototype.push.apply(c.currentEntity.children.list,a.list),c.currentEntity.children.hasNext=a.hasNext};e(c.currentEntity.entity,{from:a}).then(b)},c.select=function(a,b){b.preventDefault(),c.selection&&c.selection()(a)},c.mouseOver=function(a){angular.isFunction(c.hovered())&&c.hovered()(a)},c.isBrowsable=function(a){return c.browsable()?c.browsable()(a):"file"!==a._entityType&&"link:file"!==a._entityType},c.isSelectable=function(a){return c.selectable&&c.selectable()?c.selectable()(a):!1},c.entity&&c.entity._parent?(c.currentEntity=f(!1,{_uuid:c.entity._parent}),a.get(c.currentEntity.entity._uuid).then(function(a){c.currentEntity.entity=a,e(a).then(function(a){c.currentEntity.children=a})})):(c.currentEntity=f(!0),e().then(function(a){c.currentEntity.children=a}))}]}}])}(),function(){"use strict";function a(a,b,c,d,e){function f(){return k=_.pick(e,function(a,b){return-1===["from","until"].indexOf(b)}),j.state="loading",b.getChildren(d,e).then(function(a){l.replace(a),j.state="ready"})["catch"](i)}function g(){return j.promise=j.promise.then(function(){return j.state="loading",b.getChildren(d,angular.extend({from:j.entities[j.entities.length-1]._uuid},k)).then(function(a){l.append(a),j.state="ready"})})["catch"](i)}function h(){return j.promise=j.promise.then(function(){return j.state="loading",b.getChildren(d,angular.extend({until:j.entities[0]._uuid},k)).then(function(a){l.prepend(a),j.state="ready"})})["catch"](i)}function i(b){j.error=b,j.state="error",a.reject(b)}var j=this;j.entities=[],j.state=null,j.error=null,j.hasNext=!1,j.hasPrevious=!1,j.next=g,j.previous=h,j.promise=f();var k,l={replace:function(a){j.hasPrevious=!!a.hasPrevious,j.hasNext=!!a.hasMore,j.entities.push.apply(j.entities,a.result)},append:function(a){j.hasNext=!!a.hasMore,a.result.shift(),j.entities.push.apply(j.entities,a.result)},prepend:function(a){j.hasPrevious=!!a.hasPrevious,a.result.pop(),j.entities.unshift.apply(j.entities,a.result)}}}angular.module("hbpDocumentClient.ui").factory("hbpLoadEntityChildren",["$q","hbpEntityStore","hbpErrorService",function(b,c,d){return function(e,f){return new a(b,c,d,e,f)}}])}(),angular.module("hbpDocumentClient.core").service("hbpEntityStore",["$http","$q","bbpConfig","hbpIdentityUserDirectory","hbpDocumentClientResolveUserIds","hbpErrorService",function(a,b,c,d,e,f){"use strict";var g=c.get("api.document.v0"),h={},i={},j=function(a,b){return i[a]||(i[a]=b()["finally"](function(){i[a]=null})),i[a]};h.get=function(b){var c=g+"/entity/"+b,d="GET "+c;return j(d,function(){return a.get(c).then(function(a){return a.data})})},h.query=function(b){return a.get(g+"/entity/",{params:b}).then(function(a){return a.data})},h.isContainer=function(a){return/.*(folder|release|project)$/.test(a._entityType)},h.getAncestors=function(a,c){if(!a||!a._parent||c&&a._parent===c._uuid)return b.when([]);var d=function(d){b.reject(f.error({type:"EntityAncestorRetrievalError",message:"Cannot retrieve some ancestors from entity "+a._name,data:{entity:a,root:c,cause:d}}))},e=function(a){return h.getAncestors(a,c).then(function(b){return b.push(a),b})};return h.get(a._parent).then(e,d)},h.getPath=function(a){var c=b.defer(),d=a._name,e=function(){c.reject("Cannot retrieve entity path")};return a._parent?h.get(a._parent).then(function(a){h.getPath(a).then(function(a){d=a+"/"+d,c.resolve(d)},e)},e):c.resolve("/"+d),c.promise};var k=function(a,b){return b&&(a=a.concat(_.map(b===!0?a:b,function(a){return"link:"+a}))),a&&a.length>0?"_entityType="+a.join("+"):void 0};return h.getChildren=function(c,d){var f=b.defer();return d=angular.extend({},d),a.get(g+"/"+c._entityType+"/"+c._uuid+"/children",{params:{filter:k(d.accept,d.acceptLink),sort:d.sort?d.sort:"_name",from:d.from,until:d.until}}).then(function(a){var b=a.data.result;d.resolveUserId&&e(b),f.resolve(a.data)},f.reject,f.notify),f.promise},h.getUserAccess=function(c){var e=b.defer();return b.all({acl:a.get(g+"/"+c._entityType+"/"+c._uuid+"/acl"),user:d.getCurrentUser()}).then(function(a){var b=a.acl.data,c=a.user,d={canRead:!1,canWrite:!1,canManage:!1};_.forEach(b,function(a,b){(b===c.id||c.groups.indexOf(b)>=0)&&(d.canRead=d.canRead||"read"===a||"write"===a||"manage"===a,d.canWrite=d.canWrite||"write"===a||"manage"===a,d.canManage=d.canManage||"manage"===a)}),e.resolve(d)},e.reject),e.promise},h.addMetadata=function(b,c){return a.post(g+"/"+b._entityType+"/"+b._uuid+"/metadata",c).then(function(a){return a.data})},h.deleteMetadata=function(b,c){return a["delete"](g+"/"+b._entityType+"/"+b._uuid+"/metadata",{data:{keys:c}}).then(function(a){return a.data})},h.create=function(c,d,e,h){return a.post(g+"/"+c.split(":")[0],angular.extend({_name:e,_parent:d&&d._uuid||d},h)).then(function(a){return a.data})["catch"](function(a){return a=0===a.code?f.error({type:"Aborted",message:"Network unreachable",code:0}):f.httpError(a),a.message.match(/already exists/)?a.type="FileAlreadyExistError":a.type="EntityCreationError",a.cause=a.type,b.reject(a)})},h}]),angular.module("hbpDocumentClient.core").provider("hbpFileStore",function(){"use strict";return{$get:["$http","$q","$log","bbpConfig","hbpEntityStore","hbpErrorService",function(a,b,c,d,e,f){var g=d.get("hbpFileStore.maxFileUploadSize",10485760),h={},i=d.get("api.document.v0"),j=function(a,b){b=b||{};var c="UploadError",d=new Error(c+": "+a+" "+b.message);return d.cause=a,d.statusText=b.message,d.name=c,d.file=b.file,d.entity=b.entity,d},k=function(){return j("Aborted")},l=function(a){return i+"/"+a._entityType.split(":")[0]+"/"+a._uuid},m=function(b){return a["delete"](l(b))},n=function(d,e,f){var g=b.defer();return a.post(l(e)+"/content/upload",d,angular.extend({headers:{"Content-Type":"application/octet-stream"}},f)).success(function(a){g.notify({lengthComputable:!0,total:d.size,loaded:d.size}),g.resolve(a)}).error(function(a,b){var f=function(){return a&&0!==b?j("UploadError",{message:a.message,file:d,entity:e}):k()};m(e).then(function(){g.reject(f(a))},function(b){c.error("Unable to remove previously created entity",b),g.reject(f(a))})}),g.promise};return h.upload=function(a,c){c=c||{};var d=b.defer(),f=b.defer();if(d.promise.abort=function(){f.resolve()},a.size>g)return d.reject(j("FileTooBig",{message:"The file `"+a.name+"` is too big("+a.size+" bytes), max file size is "+g+" bytes."})),d.promise;var h={_contentType:a.type};return e.create("file",c.parent&&c.parent._uuid,a.name,h).then(function(b){d.notify({lengthComputable:!0,total:a.size,loaded:0}),n(a,b,{timeout:f.promise,uploadProgress:function(a){d.notify(a)}}).then(function(a){d.promise.abort=function(){m(a),f.resolve()},d.resolve(a)},d.reject,d.notify)},d.reject),d.promise},h.requestSignedUrl=function(b){return c.debug("hbpFileStore.requestSignedUrl(id) is deprecated, use hbpFileStore.downloadUrl(entityOrId) instead"),a.get(i+"/file/"+b+"/content/secure_link").then(function(a){return a.data})},h.downloadUrl=function(c){var d=c._uuid||c;return a.get(i+"/file/"+d+"/content/secure_link").then(function(a){return i+a.data.signed_url},function(a){return b.reject(f.httpError(a))})},h.getContent=function(b){return a({method:"GET",url:i+"/file/"+b+"/content",transformResponse:function(a){return a}}).then(function(a){return a.data})},h.maxFileSize=function(){return g},h}]}}),angular.module("hbpDocumentClient.core").service("hbpProjectStore",["$http","$q","bbpConfig","hbpDocumentClientResolveUserIds",function(a,b,c,d){"use strict";function e(b,c){var d=c||[];return a.get(f+"/project",{params:{sort:b.sort?b.sort:"_name",from:b.from,until:b.until,filter:b.filter,access:b.access,limit:b.pageSize>0?b.pageSize:null}}).then(function(a){if(d.push.apply(d,a.data.result),0===b.pageSize&&a.data.hasMore){var c=_.last(d)._uuid,f=angular.extend({},b,{from:c});return d.pop(),e(f,d)}return{result:d,hasMore:a.data.hasMore}})}var f=c.get("api.document.v0"),g={};return g.getAll=function(a){var c=b.defer();return a=angular.extend({},a),e(a).then(function(b){var e=b.result;a.resolveUserId&&d(e),c.resolve(b)},c.reject,c.notify),c.promise},g}]),angular.module("hbpDocumentClient").factory("hbpDocumentClientResolveUserIds",["hbpIdentityUserDirectory",function(a){"use strict";return function(b){var c=_.map(b,"_createdBy");a.get(c).then(function(a){for(var c=0;c<b.length;c++){var d=a[b[c]._createdBy];d?b[c]._createdByName=d.displayName:b[c]._createdByName=b[c]._createdBy}})}}]);